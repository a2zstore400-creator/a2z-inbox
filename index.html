<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2Z STORE | ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00439c; --bg: #f4f6f8; --card: #ffffff; --text: #0f172a; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        .auth-container { background: var(--card); width: 100%; max-width: 400px; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .logo { font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 10px; }
        .subtitle { color: #64748b; margin-bottom: 30px; font-size: 0.9rem; }
        
        .input-group { margin-bottom: 20px; text-align: right; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #334155; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Cairo'; font-size: 1rem; box-sizing: border-box; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); }
        .email-preview { direction: ltr; text-align: right; margin-top: 5px; font-size: 0.85rem; color: var(--primary); font-weight: bold; display: none; }
        
        .btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; font-family: 'Cairo'; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn:hover { background: #00337a; transform: translateY(-2px); }
        
        .toggle-text { margin-top: 20px; color: #64748b; font-size: 0.9rem; }
        .toggle-text span { color: var(--primary); font-weight: bold; cursor: pointer; }
        
        .error-msg { color: #ef4444; background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; font-weight: bold; display: none; }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #register-section { display: none; }
    </style>
</head>
<body>

    <div class="auth-container">
        <div class="logo">ğŸ® A2Z Mail</div>
        <div class="subtitle" id="form-subtitle">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ</div>
        
        <div class="error-msg" id="error-box"></div>

        <div id="login-section">
            <div class="input-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="login-username" placeholder="Ù…Ø«Ø§Ù„: admin" autocomplete="off">
            </div>
            <div class="input-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="btn" onclick="login()">Ø¯Ø®ÙˆÙ„ ğŸš€</button>
            <div class="toggle-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <span onclick="toggleForm('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</span></div>
        </div>

        <div id="register-section">
            <div class="input-group">
                <label>Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</label>
                <input type="text" id="reg-username" placeholder="Ù…Ø«Ø§Ù„: ahmed" oninput="updateEmailPreview()" autocomplete="off">
                <div class="email-preview" id="email-preview">Ø³ÙŠØµØ¨Ø­ Ø¨Ø±ÙŠØ¯Ùƒ: <span></span>@a2z-mail.com</div>
            </div>
            <div class="input-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="reg-password" placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
            </div>
            <button class="btn" onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…</button>
            <div class="toggle-text">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <span onclick="toggleForm('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></div>
        </div>
    </div>

    <script>
        const S_URL = 'https://cdfvubqbujwjvkbztrvp.supabase.co';
        const S_KEY = 'sb_publishable_AUFSPxGYb0Vl_C3rbEw1gg_E75YdCop';
        const myApp = supabase.createClient(S_URL, S_KEY);

        function toggleForm(type) {
            const loginSec = document.getElementById('login-section');
            const regSec = document.getElementById('register-section');
            const subtitle = document.getElementById('form-subtitle');
            const errorBox = document.getElementById('error-box');
            errorBox.style.display = 'none';

            if (type === 'register') {
                loginSec.style.display = 'none';
                regSec.style.display = 'block';
                subtitle.innerText = 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¬Ø§Ù†Ø§Ù‹';
            } else {
                loginSec.style.display = 'block';
                regSec.style.display = 'none';
                subtitle.innerText = 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ';
            }
        }

        function updateEmailPreview() {
            const input = document.getElementById('reg-username').value.trim().toLowerCase();
            const preview = document.getElementById('email-preview');
            // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
            const validUser = input.replace(/[^a-z0-9_.-]/g, '');
            document.getElementById('reg-username').value = validUser;

            if (validUser.length > 0) {
                preview.style.display = 'block';
                preview.querySelector('span').innerText = validUser;
            } else {
                preview.style.display = 'none';
            }
        }

        function showError(msg) {
            const errorBox = document.getElementById('error-box');
            errorBox.innerText = msg;
            errorBox.style.display = 'block';
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function login() {
            const user = document.getElementById('login-username').value.trim().toLowerCase();
            const pass = document.getElementById('login-password').value;

            if(!user || !pass) return showError('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!');

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const { data, error } = await myApp.from('a2z_users').select('*').eq('username', user).eq('password', pass).single();

            if (error || !data) {
                return showError('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
            }

            // ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø± (Ban)
            if (data.status === 'banned') {
                return showError('â›” ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.');
            }

            // Ù„Ùˆ ÙƒÙ„Ù‡ ØªÙ…Ø§Ù…ØŒ Ù†Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙˆÙ†Ù†Ù‚Ù„Ù‡ Ù„Ù„Ø±Ø³Ø§ÙŠÙ„
            localStorage.setItem('a2z_user', JSON.stringify(data));
            window.location.href = 'inbox.html';
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
        async function register() {
            const user = document.getElementById('reg-username').value.trim().toLowerCase();
            const pass = document.getElementById('reg-password').value;

            if(user.length < 3) return showError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            if(pass.length < 6) return showError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');

            const fullEmail = `${user}@a2z-mail.com`;

            // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase (Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‡ÙŠØ±ÙØ¶ Ù„ÙˆØ­Ø¯Ù‡ Ø¹Ø´Ø§Ù† Ø¹Ù…Ù„Ù†Ø§ UNIQUE)
            const { data, error } = await myApp.from('a2z_users').insert([
                { username: user, password: pass, email_address: fullEmail }
            ]).select().single();

            if (error) {
                if (error.code === '23505') { // ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£ Ø¨ØªØ§Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                    return showError('Ø¹ÙÙˆØ§Ù‹ØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø­Ø¬ÙˆØ² Ù„Ø´Ø®Øµ Ø¢Ø®Ø±!');
                }
                return showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message);
            }

            // Ù„Ùˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ø¬Ø­ØŒ ÙŠØ¯Ø®Ù„ ÙÙˆØ±Ø§Ù‹
            localStorage.setItem('a2z_user', JSON.stringify(data));
            window.location.href = 'inbox.html';
        }

        // Ù„Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ ÙŠØ¯Ø®Ù„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù„Ø·ÙˆÙ„
        window.onload = function() {
            if(localStorage.getItem('a2z_user')) {
                window.location.href = 'inbox.html';
            }
        }
    </script>
</body>
</html>
