<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>A2Z Mail | Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f1f5f9; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-family: 'Cairo'; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #00439c; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .back-link { display: block; margin-top: 15px; color: #64748b; text-decoration: none; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="card" id="step-1">
        <h2>ğŸ”‘ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</h2>
        <p>Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ùƒ ÙÙŠ A2Z Mail Ø¹Ø´Ø§Ù† Ù†Ø¨Ø¹ØªÙ„Ùƒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯.</p>
        <input type="text" id="email-input" placeholder="example@a2z-mail.com">
        <button onclick="checkUser()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ğŸš€</button>
        <a href="login.html" class="back-link">Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    </div>

    <div class="card" id="step-2" style="display: none;">
        <h2>ğŸ“© ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ</h2>
        <p>Ø¨Ø¹ØªÙ†Ø§ ÙƒÙˆØ¯ Ø³Ø±ÙŠ Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø¨ÙˆØ· Ø¨Ø­Ø³Ø§Ø¨Ùƒ.</p>
        <input type="text" id="code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…">
        <input type="password" id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
        <button onclick="updatePassword()">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± âœ…</button>
    </div>

    <script>
        const S_URL = 'https://cdfvubqbujwjvkbztrvp.supabase.co';
        const S_KEY = 'sb_publishable_AUFSPxGYb0Vl_C3rbEw1gg_E75YdCop';
        const myApp = supabase.createClient(S_URL, S_KEY);

        let correctCode = ""; // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø§Ù„Ø³ÙŠØ³ØªÙ… Ù‡ÙŠÙˆÙ„Ø¯Ù‡
        let targetUserEmail = ""; 

        async function checkUser() {
            const email = document.getElementById('email-input').value;
            if(!email) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„!");

            // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ³Ø­Ø¨ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ [cite: 2026-02-13]
            const { data, error } = await myApp.from('a2z_users').select('recovery_email, email_address').eq('email_address', email).single();

            if (data) {
                targetUserEmail = data.email_address;
                // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…
                correctCode = Math.floor(100000 + Math.random() * 900000).toString();

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Worker Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡ [cite: 2026-02-14]
                try {
                    await fetch("https://late-butterfly-bd1a.a2z-store400.workers.dev", {
                        method: 'POST',
                        body: JSON.stringify({
                            from: "A2Z Security <security@a2z-mail.com>",
                            to: data.recovery_email, 
                            subject: "ÙƒÙˆØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ A2Z Mail",
                            html: `<div dir="rtl"><h2>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: <span style="color:#00439c">${correctCode}</span></h2><p>Ù„Ùˆ Ù…ÙƒÙ†ØªØ´ Ø¥Ù†Øª Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨Øª Ø§Ù„ÙƒÙˆØ¯ØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ.</p></div>`
                        })
                    });
                    
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                } catch(e) {
                    alert("Ø­ØµÙ„ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ØŒ Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ.");
                }
            } else {
                alert("Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¯Ù‡ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ù†Ø§ØŒ Ø§ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© ØµØ­.");
            }
        }

        async function updatePassword() {
            const userCode = document.getElementById('code-input').value;
            const newPass = document.getElementById('new-password').value;

            if (userCode === correctCode) {
                const { error } = await myApp.from('a2z_users').update({ password: newPass }).eq('email_address', targetUserEmail);
                if (!error) {
                    alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰ ØªÙ‚Ø¯Ø± ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¯Ù„ÙˆÙ‚ØªÙŠ.");
                    window.location.href = 'login.html';
                }
            } else {
                alert("Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø¯Ø®Ù„ØªÙ‡ ØºÙ„Ø·!");
            }
        }
    </script>
</body>
</html>
