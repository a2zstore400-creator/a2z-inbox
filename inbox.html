<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2Z STORE | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00439c; --bg: #f4f6f8; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --danger: #ef4444; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Style */
        .sidebar { width: 250px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; z-index: 10; box-shadow: -2px 0 10px rgba(0,0,0,0.02); }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--primary); margin-bottom: 30px; text-align: center; }
        .menu-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; display: flex; align-items: center; gap: 10px; color: #475569; }
        .menu-item.active { background: #e0e7ff; color: var(--primary); }
        .menu-item:hover:not(.active) { background: #f1f5f9; color: var(--primary); }
        .btn-compose { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; font-family: 'Cairo'; cursor: pointer; margin-bottom: 20px; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,67,156,0.2); }
        .admin-only { border: 2px solid #fbbf24; color: #92400e; display: none; margin-top: 10px; background: #fffbeb; }

        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .header { background: var(--card); padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .user-email { font-size: 0.9rem; color: var(--primary); background: #e0e7ff; padding: 6px 15px; border-radius: 20px; font-weight: bold; }

        /* Search & List */
        .search-area { padding: 15px 20px; background: #fff; border-bottom: 1px solid var(--border); }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 10px; border: 1px solid var(--border); font-family: 'Cairo'; outline: none; }
        
        .workspace { display: flex; flex: 1; overflow: hidden; }
        .email-list-container { width: 35%; border-left: 1px solid var(--border); background: var(--card); overflow-y: auto; }
        .email-item { padding: 15px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .email-item.selected { background: #eff6ff; border-right: 4px solid var(--primary); }
        .e-sender { font-weight: bold; color: #0f172a; }
        .e-subject { font-size: 0.9rem; color: #475569; }

        /* Admin Panel Style */
        #admin-panel { display: none; flex: 1; padding: 30px; overflow-y: auto; background: #fff; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 15px; border-bottom: 1px solid var(--border); text-align: right; }
        .admin-table th { background: #f8fafc; color: #64748b; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-banned { background: #fee2e2; color: #991b1b; }
        .btn-ban { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; }

        /* Reader */
        .email-reader { flex: 1; background: var(--card); display: flex; flex-direction: column; }
        .iframe-container { flex: 1; width: 100%; border: none; }
        .reader-header { padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border); display: none; }

        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-box { background:white; width:500px; padding:25px; border-radius:15px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">ğŸ® A2Z Mail</div>
        <button class="btn-compose" onclick="openCompose()">âœï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø©</button>
        
        <div class="menu-item active" id="tab-inbox" onclick="showMailSection('inbox')">ğŸ“¥ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯</div>
        <div class="menu-item" id="tab-sent" onclick="showMailSection('sent')">ğŸ“¤ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„</div>
        
        <div class="menu-item admin-only" id="tab-admin" onclick="showAdminSection()">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        
        <div class="menu-item" style="margin-top:auto; color:red;" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</div>
    </div>

    <div class="main-content">
        <div class="header">
            <div>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="display-name" style="color:var(--primary); font-weight:bold;"></span></div>
            <div class="user-email" id="display-email"></div>
        </div>

        <div id="mail-section" style="display: flex; flex-direction: column; flex: 1;">
            <div class="search-area">
                <input type="text" class="search-input" id="search-box" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„..." oninput="filterEmails()">
            </div>
            <div class="workspace">
                <div class="email-list-container" id="emails-list"></div>
                <div class="email-reader">
                    <div id="empty-reader" style="text-align:center; padding:100px; color:#94a3b8;">Ø§Ø®ØªØ± Ø±Ø³Ø§Ù„Ø© Ù„Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§</div>
                    <div class="reader-header" id="reader-header">
                        <div style="float:left;">
                            <button onclick="deleteEmail()" style="background:red; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">Ø­Ø°Ù ğŸ—‘ï¸</button>
                        </div>
                        <h3 id="reader-subject" style="margin:0 0 10px 0;"></h3>
                        <div id="reader-meta" style="font-size:0.85rem; color:#64748b;"></div>
                    </div>
                    <iframe id="reader-frame" class="iframe-container" style="display:none;"></iframe>
                </div>
            </div>
        </div>

        <div id="admin-panel">
            <h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <p>ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ù‡Ù†Ø§ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø­Ø¸Ø± (Ban) Ù„Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ†.</p>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="compose-modal">
        <div class="modal-box">
            <h3>âœï¸ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <input type="email" id="compose-to" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Ø¥Ù„Ù‰">
            <input type="text" id="compose-subject" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹">
            <textarea id="compose-body" style="width:100%; height:150px; padding:10px;" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰"></textarea>
            <div style="margin-top:15px; text-align:left;">
                <button onclick="closeCompose()">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="sendEmail()" id="btn-send" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:5px;">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
            </div>
        </div>
    </div>

    <script>
        const userData = JSON.parse(localStorage.getItem('a2z_user'));
        if (!userData) window.location.href = 'index.html';

        const S_URL = 'https://cdfvubqbujwjvkbztrvp.supabase.co';
        const S_KEY = 'sb_publishable_AUFSPxGYb0Vl_C3rbEw1gg_E75YdCop';
        const myApp = supabase.createClient(S_URL, S_KEY);

        document.getElementById('display-name').innerText = userData.username;
        document.getElementById('display-email').innerText = userData.email_address;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ùˆ Ù‡Ùˆ Ø±Ù…Ø¶Ø§Ù† (ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹)
        if (userData.email_address === 'admin@a2z-mail.com' || userData.username === 'Ø±Ù…Ø¶Ø§Ù†' || userData.username === 'Ramadan') {
            document.getElementById('tab-admin').style.display = 'flex';
        }

        let allEmails = [];
        let currentTab = 'inbox';
        let selectedEmailId = null;

        async function fetchEmails() {
            let q = myApp.from('emails').select('*').order('created_at', {ascending:false});
            if(currentTab === 'inbox') q = q.eq('recipient', userData.email_address);
            else q = q.ilike('sender', `%${userData.email_address}%`);
            
            const {data} = await q;
            allEmails = data || [];
            renderList(allEmails);
        }

        function renderList(list) {
            const container = document.getElementById('emails-list');
            container.innerHTML = list.map((e, i) => `
                <div class="email-item" onclick="openEmail(${i}, this)">
                    <div class="e-sender">${currentTab==='inbox'?e.sender.split('<')[0]:e.recipient}</div>
                    <div class="e-subject">${e.subject || '(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)'}</div>
                </div>
            `).join('');
        }

        function openEmail(i, el) {
            const e = allEmails[i];
            selectedEmailId = e.id;
            document.querySelectorAll('.email-item').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('empty-reader').style.display = 'none';
            document.getElementById('reader-header').style.display = 'block';
            document.getElementById('reader-frame').style.display = 'block';
            document.getElementById('reader-subject').innerText = e.subject;
            document.getElementById('reader-meta').innerText = `Ù…Ù†: ${e.sender}`;
            
            // ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ·
            let body = e.body_text;
            if(body.includes('base64')) { try{body = atob(body.split('\n\n')[1]);}catch(err){} }
            
            const doc = `<body style="font-family:sans-serif; direction:rtl;">${body}</body>`;
            document.getElementById('reader-frame').srcdoc = doc;
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ---
        async function showAdminSection() {
            document.getElementById('mail-section').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-admin').classList.add('active');
            
            const { data: users } = await myApp.from('a2z_users').select('*');
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email_address}</td>
                    <td><span class="status-badge ${u.status === 'banned' ? 'status-banned' : 'status-active'}">${u.status || 'active'}</span></td>
                    <td>
                        <button class="btn-ban" style="background:${u.status === 'banned' ? '#22c55e' : '#ef4444'}; color:white;" 
                                onclick="toggleUserStatus('${u.id}', '${u.status}')">
                            ${u.status === 'banned' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø± User'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleUserStatus(uid, currentStatus) {
            const newStatus = currentStatus === 'banned' ? 'active' : 'banned';
            const { error } = await myApp.from('a2z_users').update({ status: newStatus }).eq('id', uid);
            if(!error) {
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­! âœ…');
                showAdminSection(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            }
        }

        function showMailSection(tab) {
            currentTab = tab;
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('mail-section').style.display = 'flex';
            document.querySelectorAll('.menu-item').forEach(x => x.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            fetchEmails();
        }

        function logout() { localStorage.removeItem('a2z_user'); window.location.href = 'index.html'; }
        function openCompose() { document.getElementById('compose-modal').style.display='flex'; }
        function closeCompose() { document.getElementById('compose-modal').style.display='none'; }
        
        window.onload = fetchEmails;
    </script>
</body>
</html>
